# Makefile para Orange Pi Zero 2
# Facilita opera√ß√µes comuns de build, deploy e manuten√ß√£o

.PHONY: help build deploy test status logs restart backup restore clean

# Configura√ß√£o
HOST := orangepizero2
USER := root
FLAKE := ..
CONFIG := orangepizero2

# Cores para output
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m

help: ## Mostra esta ajuda
	@echo "$(GREEN)Orange Pi Zero 2 - Comandos Dispon√≠veis$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)Exemplos:$(NC)"
	@echo "  make build          # Build local"
	@echo "  make deploy         # Deploy remoto"
	@echo "  make test           # Testar servidor"
	@echo "  make logs           # Ver logs"

build: ## Build local no Orange Pi (via SSH)
	@echo "$(GREEN)üî® Building no Orange Pi...$(NC)"
	ssh $(USER)@$(HOST) "cd /root/dotfiles && sudo nixos-rebuild build --flake .#$(CONFIG)"
	@echo "$(GREEN)‚úÖ Build conclu√≠do!$(NC)"

switch: ## Aplicar configura√ß√£o localmente no Orange Pi
	@echo "$(GREEN)üîÑ Aplicando configura√ß√£o no Orange Pi...$(NC)"
	ssh $(USER)@$(HOST) "cd /root/dotfiles && sudo nixos-rebuild switch --flake .#$(CONFIG)"
	@echo "$(GREEN)‚úÖ Configura√ß√£o aplicada!$(NC)"

deploy: ## Build e deploy remoto do desktop
	@echo "$(GREEN)üöÄ Deploy remoto para Orange Pi...$(NC)"
	cd $(FLAKE) && sudo nixos-rebuild switch --flake .#$(CONFIG) --target-host $(USER)@$(HOST)
	@echo "$(GREEN)‚úÖ Deploy conclu√≠do!$(NC)"

test: ## Executar script de teste
	@echo "$(GREEN)üß™ Testando Taskchampion Sync Server...$(NC)"
	@echo ""
	ssh $(USER)@$(HOST) 'bash -s' < scripts/test-taskchampion.sh

status: ## Ver status do servi√ßo
	@echo "$(GREEN)üìä Status do Taskchampion Sync Server:$(NC)"
	@echo ""
	@ssh $(USER)@$(HOST) 'sudo systemctl status taskchampion-sync-server'

logs: ## Ver logs em tempo real
	@echo "$(GREEN)üìú Logs do Taskchampion Sync Server (Ctrl+C para sair):$(NC)"
	@echo ""
	@ssh $(USER)@$(HOST) 'sudo journalctl -u taskchampion-sync-server -f'

logs-recent: ## Ver √∫ltimas 50 linhas do log
	@echo "$(GREEN)üìú √öltimas 50 linhas do log:$(NC)"
	@echo ""
	@ssh $(USER)@$(HOST) 'sudo journalctl -u taskchampion-sync-server -n 50 --no-pager'

restart: ## Reiniciar servi√ßo
	@echo "$(YELLOW)üîÑ Reiniciando Taskchampion Sync Server...$(NC)"
	@ssh $(USER)@$(HOST) 'sudo systemctl restart taskchampion-sync-server'
	@sleep 2
	@echo "$(GREEN)‚úÖ Servi√ßo reiniciado!$(NC)"
	@echo ""
	@make status

stop: ## Parar servi√ßo
	@echo "$(YELLOW)‚è∏Ô∏è  Parando Taskchampion Sync Server...$(NC)"
	@ssh $(USER)@$(HOST) 'sudo systemctl stop taskchampion-sync-server'
	@echo "$(GREEN)‚úÖ Servi√ßo parado!$(NC)"

start: ## Iniciar servi√ßo
	@echo "$(GREEN)‚ñ∂Ô∏è  Iniciando Taskchampion Sync Server...$(NC)"
	@ssh $(USER)@$(HOST) 'sudo systemctl start taskchampion-sync-server'
	@sleep 2
	@echo "$(GREEN)‚úÖ Servi√ßo iniciado!$(NC)"
	@echo ""
	@make status

backup: ## Criar backup dos dados
	@echo "$(GREEN)üíæ Criando backup...$(NC)"
	@ssh $(USER)@$(HOST) 'sudo tar -czf /tmp/taskchampion-backup-$$(date +%Y%m%d-%H%M%S).tar.gz -C /var/lib/taskchampion-sync-server .'
	@echo "$(GREEN)‚úÖ Backup criado em /tmp/$(NC)"
	@ssh $(USER)@$(HOST) 'ls -lh /tmp/taskchampion-backup-*.tar.gz | tail -1'

backup-download: ## Criar backup e baixar para local
	@echo "$(GREEN)üíæ Criando e baixando backup...$(NC)"
	@ssh $(USER)@$(HOST) 'sudo tar -czf /tmp/taskchampion-backup-$$(date +%Y%m%d-%H%M%S).tar.gz -C /var/lib/taskchampion-sync-server .'
	@BACKUP_FILE=$$(ssh $(USER)@$(HOST) 'ls -t /tmp/taskchampion-backup-*.tar.gz | head -1'); \
	scp $(USER)@$(HOST):$$BACKUP_FILE ./backups/; \
	echo "$(GREEN)‚úÖ Backup baixado para ./backups/$(NC)"

restore: ## Restaurar backup (requer BACKUP_FILE=caminho)
	@if [ -z "$(BACKUP_FILE)" ]; then \
		echo "$(RED)‚ùå Erro: Especifique BACKUP_FILE=caminho$(NC)"; \
		echo "Exemplo: make restore BACKUP_FILE=./backups/taskchampion-backup-20260226.tar.gz"; \
		exit 1; \
	fi
	@echo "$(YELLOW)‚ö†Ô∏è  Restaurando backup: $(BACKUP_FILE)$(NC)"
	@echo "$(YELLOW)‚ö†Ô∏è  Isso ir√° sobrescrever os dados atuais!$(NC)"
	@read -p "Continuar? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		scp $(BACKUP_FILE) $(USER)@$(HOST):/tmp/restore.tar.gz; \
		ssh $(USER)@$(HOST) 'sudo systemctl stop taskchampion-sync-server'; \
		ssh $(USER)@$(HOST) 'sudo rm -rf /var/lib/taskchampion-sync-server/*'; \
		ssh $(USER)@$(HOST) 'sudo tar -xzf /tmp/restore.tar.gz -C /var/lib/taskchampion-sync-server/'; \
		ssh $(USER)@$(HOST) 'sudo chown -R taskchampion:taskchampion /var/lib/taskchampion-sync-server/'; \
		ssh $(USER)@$(HOST) 'sudo systemctl start taskchampion-sync-server'; \
		echo "$(GREEN)‚úÖ Backup restaurado!$(NC)"; \
	else \
		echo "$(YELLOW)Opera√ß√£o cancelada$(NC)"; \
	fi

info: ## Informa√ß√µes do sistema
	@echo "$(GREEN)‚ÑπÔ∏è  Informa√ß√µes do Orange Pi Zero 2:$(NC)"
	@echo ""
	@echo "$(YELLOW)Hostname:$(NC)"
	@ssh $(USER)@$(HOST) 'hostname'
	@echo ""
	@echo "$(YELLOW)IP:$(NC)"
	@ssh $(USER)@$(HOST) "ip -4 addr show end0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'"
	@echo ""
	@echo "$(YELLOW)Uptime:$(NC)"
	@ssh $(USER)@$(HOST) 'uptime'
	@echo ""
	@echo "$(YELLOW)Mem√≥ria:$(NC)"
	@ssh $(USER)@$(HOST) 'free -h'
	@echo ""
	@echo "$(YELLOW)Disco:$(NC)"
	@ssh $(USER)@$(HOST) 'df -h /'
	@echo ""
	@echo "$(YELLOW)Temperatura:$(NC)"
	@ssh $(USER)@$(HOST) 'cat /sys/class/thermal/thermal_zone0/temp | awk "{print \$$1/1000 \"¬∞C\"}"' || echo "N/A"

connections: ## Ver conex√µes ativas na porta 8080
	@echo "$(GREEN)üîå Conex√µes ativas:$(NC)"
	@echo ""
	@ssh $(USER)@$(HOST) 'sudo ss -tnp | grep :8080'

data-size: ## Ver tamanho dos dados
	@echo "$(GREEN)üìä Tamanho dos dados:$(NC)"
	@echo ""
	@ssh $(USER)@$(HOST) 'sudo du -sh /var/lib/taskchampion-sync-server/'
	@echo ""
	@ssh $(USER)@$(HOST) 'sudo ls -lh /var/lib/taskchampion-sync-server/'

clean-backups: ## Limpar backups antigos (mant√©m √∫ltimos 5)
	@echo "$(YELLOW)üßπ Limpando backups antigos...$(NC)"
	@ssh $(USER)@$(HOST) 'ls -t /tmp/taskchampion-backup-*.tar.gz | tail -n +6 | xargs -r rm'
	@echo "$(GREEN)‚úÖ Backups antigos removidos!$(NC)"

update-flake: ## Atualizar flake.lock
	@echo "$(GREEN)üîÑ Atualizando flake...$(NC)"
	cd $(FLAKE) && nix flake update
	@echo "$(GREEN)‚úÖ Flake atualizado!$(NC)"

rebuild-update: update-flake deploy ## Atualizar flake e fazer deploy

ssh: ## SSH no Orange Pi
	@ssh $(USER)@$(HOST)

ping: ## Testar conectividade
	@echo "$(GREEN)üèì Testando conectividade...$(NC)"
	@ping -c 4 $(HOST)

curl-test: ## Testar servidor HTTP
	@echo "$(GREEN)üåê Testando servidor HTTP...$(NC)"
	@curl -v http://$(HOST):8080 2>&1 | head -20

docs: ## Abrir documenta√ß√£o principal
	@less TASKWARRIOR-SETUP.md

docs-security: ## Abrir guia de seguran√ßa
	@less docs/taskwarrior-security.md

docs-troubleshooting: ## Abrir guia de troubleshooting
	@less docs/taskwarrior-troubleshooting.md

docs-quick: ## Abrir refer√™ncia r√°pida
	@less docs/taskwarrior-quick-reference.md

docs-tailscale: ## Abrir guia do Tailscale
	@less docs/tailscale-setup.md

tailscale-status: ## Ver status do Tailscale
	@echo "$(GREEN)üîê Status do Tailscale:$(NC)"
	@echo ""
	@ssh $(USER)@$(HOST) 'sudo tailscale status'

tailscale-ip: ## Ver IP do Tailscale
	@echo "$(GREEN)üåê IP do Tailscale:$(NC)"
	@echo ""
	@ssh $(USER)@$(HOST) 'sudo tailscale ip -4'

tailscale-up: ## Conectar Tailscale
	@echo "$(GREEN)üîå Conectando Tailscale...$(NC)"
	@ssh $(USER)@$(HOST) 'sudo tailscale up'
	@echo ""
	@make tailscale-status

tailscale-down: ## Desconectar Tailscale
	@echo "$(YELLOW)üîå Desconectando Tailscale...$(NC)"
	@ssh $(USER)@$(HOST) 'sudo tailscale down'
	@echo "$(GREEN)‚úÖ Desconectado!$(NC)"

tailscale-logs: ## Ver logs do Tailscale
	@echo "$(GREEN)üìú Logs do Tailscale (Ctrl+C para sair):$(NC)"
	@echo ""
	@ssh $(USER)@$(HOST) 'sudo journalctl -u tailscaled -f'

clean: ## Limpar arquivos tempor√°rios
	@echo "$(YELLOW)üßπ Limpando arquivos tempor√°rios...$(NC)"
	@rm -f *.log *.tmp
	@echo "$(GREEN)‚úÖ Limpeza conclu√≠da!$(NC)"

.DEFAULT_GOAL := help
